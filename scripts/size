#!/bin/bash
j=0
for i in ".text" ".data" ".bss"
do
	val[$j]=$(avr-size -A $1 | grep $i | sed -e "s/^$i *//g" | cut -d " " -f1)
	let j=$j+1
done

IMAGESIZE=$(ls -l $1.bin | awk '{ print $5 }')
FLASHSIZE=$(perl -e "print 0x$(echo -e "#include <avr/io.h>\nFLASHEND" | avr-cpp -mmcu=$2 | tail -n 1 |cut -c3-);")
FLASHSIZE=$[$FLASHSIZE + 1]
PERCENT=$(perl -e "printf('%.2f', $IMAGESIZE.0 / $FLASHSIZE.0 *100.0);" )

echo ""
echo "Program: $(perl -e "print ${val[0]}+${val[1]};") bytes"
echo "(.text + .data)"
echo ""
echo "Data:  $(perl -e "print ${val[2]}+${val[1]};") bytes"
echo "(.data + .bss)"
echo ""
echo "Imagesize: $IMAGESIZE bytes (${PERCENT}%)"
echo "Available flash: $FLASHSIZE bytes ($2)"
if [ $IMAGESIZE -gt $FLASHSIZE ];then
  echo "  WARNING! Your Image is too big for the selected chip. WARNING!"
  echo ""
  exit 1
fi
echo ""
