#!/bin/bash

if [ -d named_pin ]; then
  cd named_pin
fi

tmp=`mktemp`
tmp2=`mktemp`
tmp3=`mktemp`
cat <<EOF
/* Autogenerated File */
#define OUTPUT 0
#define INPUT 1
#define LOW 0
#define HIGH 1
EOF
echo "const struct PinConfiguration portio_pincfg[] PROGMEM = {" >> $tmp
echo -e "    /*  port\tpin\tinput\treverse? */" >> $tmp
echo -e "/* Autogenerated File*/\n#ifndef NAMEDPIN_CONF\n#define NAMEDPIN_CONF\n" >> $tmp3
grep -v -e ^# < config | while read line; do
  port=`echo $line | awk '{print $1}' | cut -c 2 | tr 'ABCDabcd' '01230123'`
  pin=`echo $line | awk '{print $1}' | cut -c 3`
  input=`echo $line | awk '{print $2}'`
  active_high=`echo $line | awk '{print $3}'`
  name=`echo $line | awk '{print $4}'`
  echo "#define ${name}_PORT `echo $line | awk '{print $1}' | cut -c 2 | tr 'abcd' 'ABCD'`" >> $tmp3
  echo "#define ${name}_PIN $pin" >> $tmp3
  textid=$RANDOM
  while grep -q $textid $tmp2; do
    textid=$RANDOM

  done
  echo $textid >> $tmp2
  echo "const char named_pin_text$textid[] PROGMEM = \"$name\";";
  echo -e "    {   $port,\t$pin,\t$input,\t$active_high,\tnamed_pin_text$textid }, \t/* $name\t*/ " >> $tmp
done

echo
cat $tmp
echo ""
echo "    /* mark the end of the list */"
echo "    { 255, 255, 255, 255, NULL}"
echo "};"

echo "#endif" >> $tmp3
cat $tmp3 > user_config.h 

rm -f $tmp $tmp2 $tmp3 
